<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAAS Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --background-color: #f8fafc;
            --container-bg: #ffffff;
            --text-color: #334155;
            --label-color: #475569;
            --border-color: #e2e8f0;
            --input-focus-border: #a5b4fc;
            --help-text-color: #64748b;
            --white: #fff;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            padding: 2rem;
            color: var(--text-color);
            background-color: var(--background-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        main {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
            color: #1e293b;
        }
        .container {
            background: var(--container-bg);
            padding: 1.5rem 2rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--label-color);
        }
        input, textarea, select {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            background-color: #f8fafc;
            color: var(--text-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--input-focus-border);
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        button {
            background: var(--primary-color);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background-color 0.2s;
            display: inline-block;
            text-align: center;
        }
        button:hover {
            background: var(--primary-hover);
        }
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 0.5rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #334155;
            font-family: 'SF Mono', 'Fira Code', 'Fira Mono', 'Roboto Mono', monospace;
            font-size: 0.875rem;
        }
        .help-text {
            font-size: 0.875rem;
            color: var(--help-text-color);
            margin-top: 0;
            margin-bottom: 1rem;
        }
        .hidden { display: none; }
        details {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem 1.5rem;
            transition: background-color 0.2s;
        }
        details[open] {
            background-color: #f8fafc;
        }
        summary {
            font-weight: 600;
            cursor: pointer;
            padding: 0.5rem 0;
        }
    </style>
</head>
<body>
    <main>
        <h1>BAAS Admin</h1>
        <p class="help-text" style="margin-bottom: 2rem; font-size: 1.125rem;">A dashboard for managing your licenses and users.</p>

        <div class="container">
            <h2>Configuration</h2>
            <label for="apiBase">API Base URL</label>
            <input type="text" id="apiBase" value="https://baas-api.satish-9f4.workers.dev">
            <p class="help-text">The full URL of your deployed worker.</p>
            <label for="adminSecret">Admin Secret</label>
            <input type="password" id="adminSecret" placeholder="Enter your admin secret">
            <p class="help-text">The secret you created with `wrangler secret put ADMIN_SECRET`.</p>
        </div>

        <div class="container">
            <h2>Configure Payment Gateway (BYOG)</h2>
            <form id="configureGatewayForm">
                <label for="gatewayProjectId">Project ID</label>
                <input type="text" id="gatewayProjectId" placeholder="e.g., geminix" required>
                <p class="help-text">The project these payment settings apply to.</p>

                <label for="gatewayProvider">Gateway Provider</label>
                <select id="gatewayProvider" name="gatewayProvider" required>
                    <option value="razorpay">Razorpay</option>
                </select>
                <p class="help-text">Select the payment gateway you are using.</p>

                <label for="gatewayApiKey">API Key</label>
                <input type="text" id="gatewayApiKey" required>
                <p class="help-text">Your API Key from the gateway's dashboard.</p>

                <label for="gatewayApiSecret">API Secret</label>
                <input type="password" id="gatewayApiSecret" required>
                <p class="help-text">Your API Secret from the gateway's dashboard.</p>

                <label for="gatewayWebhookSecret">Webhook Secret</label>
                <input type="password" id="gatewayWebhookSecret" required>
                <p class="help-text">The secret you configured for your webhook in the gateway's dashboard.</p>

                <button type="submit">Save Gateway Configuration</button>
            </form>
            <div class="help-text" style="margin-top: 1rem;">
                <p>After saving, you must configure your payment gateway to send `payment.captured` webhooks to the following URL:</p>
                <pre id="webhookUrl" style="font-size: 0.8rem; padding: 0.5rem;"></pre>
            </div>
        </div>

        <div class="container">
            <h2>Define Self-Service Trial Plan</h2>
            <form id="defineTrialForm">
                <label for="trialProjectId">Project ID</label>
                <input type="text" id="trialProjectId" placeholder="e.g., geminix" required>
                <p class="help-text">The unique ID of the project you want to set a trial for.</p>

                <label for="trialDurationDays">Trial Duration (Days)</label>
                <input type="number" id="trialDurationDays" value="7" required>
                <p class="help-text">How long the self-service trial will last.</p>

                <label for="trialQuotas">Trial Quotas (JSON)</label>
                <textarea id="trialQuotas" rows="4">{ "daily": 100 }</textarea>
                <p class="help-text">API limits for users who sign up for this trial.</p>

                <button type="submit">Set Trial Plan</button>
            </form>
            <p class="help-text" style="margin-top: 1rem;">This sets the default trial that users will receive when they sign up via the 'One-Click' flow.</p>
        </div>

        <div class="container">
            <h2>Issue Individual License</h2>
            <form id="issueIndividualLicenseForm">
                <label for="plan">Select a Plan (to pre-fill)</label>
                <select id="plan" name="plan">
                    <option value="custom">Custom</option>
                    <option value="basic">Basic (365 days, 1k/day)</option>
                    <option value="pro">Pro (365 days, 5k/day)</option>
                    <option value="advanced">Advanced (365 days, 10k/day + AI)</option>
                </select>
                <p class="help-text">Choose a plan to start, or select "Custom" to define your own.</p>

                <label for="userEmail">User Email</label>
                <input type="email" id="userEmail" required>
                <p class="help-text">The email address of the user who will receive this license.</p>

                <label for="individualProjectId">Project ID</label>
                <input type="text" id="individualProjectId" value="my-awesome-app" required>
                <p class="help-text">The identifier for your application that will use this license.</p>

                <label for="individualDurationDays">Duration (Days)</label>
                <input type="number" id="individualDurationDays" value="365" required>
                <p class="help-text">How many days this license will be valid for after activation.</p>

                <label for="individualQuotas">Quotas (JSON)</label>
                <textarea id="individualQuotas" rows="4">{ "daily": 1000 }</textarea>
                <p class="help-text">Define API limits. 'daily' is the overall limit. Use 'byCategory' for specific buckets.</p>

                <button type="submit">Issue License</button>
            </form>
        </div>

        <div class="container hidden" id="emailContainer">
            <h2>Email for User</h2>
            <p class="help-text">Copy and paste the following email to send the license to the user.</p>
            <textarea id="emailBody" rows="10"></textarea>
        </div>

        <div class="container">
            <h2>Create Coupon Code</h2>
            <form id="createCouponForm">
                <label for="couponCode">Coupon Code</label>
                <input type="text" id="couponCode" placeholder="e.g., GEMINIX_TRIAL_7DAY" required>
                <p class="help-text">A unique code users will enter to claim their license.</p>

                <label for="couponProjectId">Project ID</label>
                <input type="text" id="couponProjectId" value="geminix" required>
                <p class="help-text">The app this coupon is for.</p>

                <label for="couponDurationDays">Duration (Days)</label>
                <input type="number" id="couponDurationDays" value="7" required>
                <p class="help-text">How long the trial will last after activation.</p>

                <label for="couponQuotas">Quotas (JSON)</label>
                <textarea id="couponQuotas" rows="4">{ "daily": 500 }</textarea>
                <p class="help-text">API limits for users who redeem this coupon.</p>

                <label for="couponMaxUses">Max Uses</label>
                <input type="number" id="couponMaxUses" value="1000" required>
                <p class="help-text">How many users can redeem this coupon.</p>

                <button type="submit">Create Coupon</button>
            </form>
        </div>

        <div class="container">
            <h2>User Analytics & Management</h2>
            <form id="findUserForm">
                <label for="findUserEmail">Find User by Email</label>
                <input type="email" id="findUserEmail">
                <label for="findUserJti">Or by License JTI</label>
                <input type="text" id="findUserJti">
                <button type="submit">Get User Details</button>
            </form>
            <pre id="userDetails" style="margin-top: 1rem;">...</pre>
            <p class="help-text"><b>Note:</b> This is a placeholder. The backend API needs to be extended to support querying individual user analytics.</p>
        </div>

        <div class="container">
            <h2>Agency & Advanced Tools</h2>
            <details>
                <summary>Expand for agency and revoke tools</summary>
                <div id="agencyTools" style="margin-top: 1.5rem;">
                    <h3>Create Agency</h3>
                    <form id="createAgencyForm">
                        <label for="agencyId">Agency ID</label>
                        <input type="text" id="agencyId" required>
                        <label for="agencyName">Agency Name</label>
                        <input type="text" id="agencyName">
                        <label for="seatQuota">Seat Quota</label>
                        <input type="number" id="seatQuota" value="10" required>
                        <button type="submit">Create Agency</button>
                    </form>
                    <hr style="margin: 2rem 0; border-color: var(--border-color);">
                    <h3>View Agency Summary</h3>
                    <form id="viewSummaryForm">
                        <label for="summaryAgencyId">Agency ID</label>
                        <input type="text" id="summaryAgencyId" required>
                        <button type="submit">Get Summary</button>
                    </form>
                    <hr style="margin: 2rem 0; border-color: var(--border-color);">
                    <h3>Revoke License</h3>
                    <form id="revokeLicenseForm">
                        <label for="jti">License JTI to Revoke</label>
                        <input type="text" id="jti" required>
                        <button type="submit">Revoke</button>
                    </form>
                </div>
            </details>
        </div>

        <div class="container">
            <h2>API Response</h2>
            <pre id="apiResponse">...</pre>
        </div>
    </main>

    <script>
        const getHeaders = () => ({
            'Content-Type': 'application/json',
            'X-Admin-Secret': document.getElementById('adminSecret').value
        });

        const apiCall = async (endpoint, body) => {
            const apiBase = document.getElementById('apiBase').value;
            const responseEl = document.getElementById('apiResponse');
            document.getElementById('emailContainer').classList.add('hidden');
            try {
                const response = await fetch(`${apiBase}${endpoint}`, {
                    method: body ? 'POST' : 'GET',
                    headers: getHeaders(),
                    body: body ? JSON.stringify(body) : null
                });
                const data = await response.json();
                responseEl.textContent = JSON.stringify(data, null, 2);
                return data;
            } catch (err) {
                responseEl.textContent = `Error: ${err.message}`;
            }
        };

        const plans = {
            basic: { durationDays: 365, quotas: { daily: 1000 } },
            pro: { durationDays: 365, quotas: { daily: 5000 } },
            advanced: { durationDays: 365, quotas: { daily: 10000, byCategory: { ai: { daily: 100 } } } }
        };

        document.getElementById('plan').addEventListener('change', e => {
            const planName = e.target.value;
            if (plans[planName]) {
                const selectedPlan = plans[planName];
                document.getElementById('individualDurationDays').value = selectedPlan.durationDays;
                document.getElementById('individualQuotas').value = JSON.stringify(selectedPlan.quotas, null, 2);
            }
        });

        document.getElementById('issueIndividualLicenseForm').addEventListener('submit', async e => {
            e.preventDefault();
            const userEmail = e.target.userEmail.value;
            const projectId = e.target.individualProjectId.value;
            const data = await apiCall('/admin/licenses/issue', {
                projectId: projectId,
                type: 'individual',
                userEmail: userEmail,
                seats: 1,
                durationDays: parseInt(e.target.individualDurationDays.value),
                quotas: JSON.parse(e.target.individualQuotas.value)
            });

            if (data && data.tokens) {
                const licenseKey = data.tokens[0];
                const emailBody = `Hello ${userEmail},\n\nWelcome! Here is your license key for ${projectId}:\n\n${licenseKey}\n\nTo activate your license, please follow the instructions in our application.\n\nThanks,\nThe Team`;
                document.getElementById('emailBody').value = emailBody;
                document.getElementById('emailContainer').classList.remove('hidden');
            }
        });
        
        document.getElementById('createCouponForm').addEventListener('submit', e => {
            e.preventDefault();
            apiCall('/admin/coupons/create', {
                code: e.target.couponCode.value,
                projectId: e.target.couponProjectId.value,
                durationDays: parseInt(e.target.couponDurationDays.value),
                quotas: JSON.parse(e.target.couponQuotas.value),
                maxUses: parseInt(e.target.couponMaxUses.value)
            });
        });

        document.getElementById('defineTrialForm').addEventListener('submit', e => {
            e.preventDefault();
            apiCall('/admin/trials/define', {
                projectId: e.target.trialProjectId.value,
                durationDays: parseInt(e.target.trialDurationDays.value),
                quotas: JSON.parse(e.target.trialQuotas.value)
            });
        });

        document.getElementById('configureGatewayForm').addEventListener('submit', e => {
            e.preventDefault();
            apiCall('/admin/gateways/configure', {
                projectId: e.target.gatewayProjectId.value,
                provider: e.target.gatewayProvider.value,
                apiKey: e.target.gatewayApiKey.value,
                apiSecret: e.target.gatewayApiSecret.value,
                webhookSecret: e.target.gatewayWebhookSecret.value
            });
        });

        const displayWebhookUrl = () => {
            const apiBase = document.getElementById('apiBase').value;
            const projectId = document.getElementById('gatewayProjectId').value || 'YOUR_PROJECT_ID';
            const provider = document.getElementById('gatewayProvider').value;
            const webhookUrl = `${apiBase}/v1/payments/webhook/${provider}?projectId=${projectId}`;
            document.getElementById('webhookUrl').textContent = webhookUrl;
        };
        document.getElementById('apiBase').addEventListener('input', displayWebhookUrl);
        document.getElementById('gatewayProjectId').addEventListener('input', displayWebhookUrl);
        document.getElementById('gatewayProvider').addEventListener('change', displayWebhookUrl);
        displayWebhookUrl();

        document.getElementById('findUserForm').addEventListener('submit', e => {
            e.preventDefault();
            const userEmail = e.target.findUserEmail.value;
            const jti = e.target.findUserJti.value;
            document.getElementById('userDetails').textContent = `// TODO: Implement API call to fetch details for\n// Email: ${userEmail || 'N/A'}\n// JTI: ${jti || 'N/A'}`;
        });

        // Agency Forms
        document.getElementById('createAgencyForm').addEventListener('submit', e => {
            e.preventDefault();
            apiCall('/admin/agencies/create', {
                agencyId: e.target.agencyId.value,
                name: e.target.agencyName.value,
                seatQuota: parseInt(e.target.seatQuota.value)
            });
        });

        document.getElementById('viewSummaryForm').addEventListener('submit', e => {
            e.preventDefault();
            apiCall(`/admin/analytics/summary?agencyId=${e.target.summaryAgencyId.value}`);
        });

        document.getElementById('revokeLicenseForm').addEventListener('submit', e => {
            e.preventDefault();
            apiCall('/admin/licenses/revoke', { jti: e.target.jti.value });
        });
    </script>
</body>
</html>